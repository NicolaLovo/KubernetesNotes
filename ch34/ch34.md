# Chapter 34 - Upgrade a Multi Node Kubernetes Cluster With Kubeadm

## Drain and cordon

Scenario: 3 worker nodes and a master node

- nginx deployment, 1 pod per node
- mysql pod on node 1

Let's say we need to replace node 1 which is "broken" -> we use a drain process:

- `kubect node NODENAME drain` -> remove all workloads from a node
  - node is marked as *unschedulable* -> node is *cordoned*
  - pods are removed and scheduled on other nodes -> node is *drained*
  - no new pods are sheduled on that node

The nginx pod, since it is managed by a deployment, will be recreated on node 2 or 3. The mysql pod, since it is not managed by a deployment will be deleted and not recreated.

Once we upgraded the node, we do:

- `kubectl node NODENAME uncordon` -> makes the node schedulable again
  - new pods can be scheduled on such node
  - existing pods are NOT necessarily moved to the new node

## Kubernetes upgrade

Scenario: currently I have Kubernetes 1.28.2 (`major.minor.patch`).

Typically when upgrading we upgrade a minor version. Now I want to upgrade to 1.30.2, but we cannot upgrade multiple minor version at the same time, we must upgrade 1 minor at the time: `1.28.2 -> 1.29.3 -> 1.30.2`

The Kubernetes team actively supports only the latest 3 versions. If 1.31 is released, 1.28 will stop being supported.

Upgrade process:

1. upgrade primary master node
2. upgrade other master nodes (only for high availability cluster)
3. upgrade worker nodes

> [NOTE]
> High availabile cluster: many master nodes with a load balancer at front. The requests to apiserver (e.g. apiserver) are distributed across the master nodes

## Upgrade strategies

### All at once

Bring down all nodes and start them together. But nodes become unhealthy and unschedulable all at the same time, impacting workloads.

Not suggested.

### Rolling update

Upgrade one node at the time. Takes more time than all at once, but workloads are not impacted.

For each node we do: drain-upgrade-uncordon

### Blue-green

Provision additional 3 nodes with the upgraded version. When ready, all workloads will be migrated to the new nodes (that will join the master in the cluster) and old nodes will be deleted.

Downside: we need to provision extra infrastructure, but it is quicker (especially if done through a cloud provider).
