# Chapter 35 - ETCD Backup And Restore

Backup all the objects -> `kubectl get all -A -o yaml > backup.yaml`

- `-A` -> include also control plane components
- export it to a yaml file
- not very efficient, does not include data inside volumes
- not always necessary -> the yaml files should be part of the github repository

What is worth is backupping the ETCD

> [NOTE]
> ETCD -> key value store that stores the cluster state

When to take the backup:

- before upgrade processes
- before major releases

However, it can be accessed only on self-managed Kubernetes cluster -> not accessible on managed Kubernetes (e.g. GKE)

- in this case use 3rd party tools

## ETCD create backup

Look at the file `/etc/kubernetes/manifests/etcd.yaml`:

- `--data-dir` -> location of data we are looking for
- `--listen-client-urls` -> urls where the ETCD is listening (e.g. where the API server gets the data for `kubectl get pods`): ETCD_ENDPOINTS
- `--key-file` -> private key of the ETCD, associated with `--cert-file`
- `--trusted-ca`: ETCD_TRUSTED_CA
- `volumeMounts` -> mounts the data-dir and the dir that stores the certificates

Now we take the backup of the data dir with the utility `etcdctl`:

1. set the env variable `ETCDCTL_API=3` -> sets the api version of etcdctl
   1. `export ETCDCTL_API=3`
2. `etcdctl --endpoints={ETCD_ENDPOINTS} --cacert={ETCD_TRUSTED_CA} --cert={ETCD_CERT_FILE} --key={ETCD_KEY_FILE} snapshot save {SNAPSHOT_FILE_TARGET_LOCATION}.db` -> create a new snapshot of etcd

Inspect the result: `etdctl --write-out=table snapshot status {SNAPSHOT_FILE_TARGET_LOCATION}.db`

## ETCD restore backup

